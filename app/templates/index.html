<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>H·ªá th·ªëng ch√¢m ph√¢n</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
</head>

<body>
    <div class="background-container"></div>

    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Menu</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="{{ url_for('web_bp.home') }}" class="nav-item active">
                    <span>üè†</span> Trang ch·ªß
                </a>
                <a href="{{ url_for('web_bp.data') }}" class="nav-item">
                    <span>üìä</span> D·ªØ li·ªáu
                </a>
                <a href="{{ url_for('web_bp.history') }}" class="nav-item">
                    <span>‚è∞</span> L·ªãch s·ª≠
                </a>
                <a href="{{ url_for('web_bp.device') }}" class="nav-item">
                    <span>‚öôÔ∏è</span> Thi·∫øt b·ªã
                </a>
                <a href="{{ url_for('web_bp.contact') }}" class="nav-item">
                    <span>üìû</span> Li√™n h·ªá
                </a>
            </nav>
            <div class="sidebar-footer">
                <a href="{{ url_for('web_bp.logout') }}" class="nav-item logout">
                    <span>üö™</span> ƒêƒÉng xu·∫•t
                </a>
            </div>
        </aside>

        <main class="main-content">
            <div class="dashboard-container">
                <header class="dashboard-header">
                    <h1>H·ªá th·ªëng ch√¢m ph√¢n t·ª± ƒë·ªông</h1>
                    <p>Sinh vi√™n th·ª±c hi·ªán : 22153120 - Ng√¥ Minh Trung , 22153111 - Nguy·ªÖn Th·ªã Hu·ªá Thu</p>
                </header>

                <section class="section-valves">
                    <h2 class="section-title">Tr·∫°ng th√°i Van</h2>
                    <div class="valves-grid">
                        <div class="valve-card" id="valve-card-1">
                            <h3>Van 1</h3>
                            <div class="status-dot" id="led-1"></div>
                        </div>
                        <div class="valve-card" id="valve-card-2">
                            <h3>Van 2</h3>
                            <div class="status-dot" id="led-2"></div>
                        </div>
                        <div class="valve-card" id="valve-card-3">
                            <h3>Van 3</h3>
                            <div class="status-dot" id="led-3"></div>
                        </div>
                        <div class="valve-card" id="valve-card-4">
                            <h3>Van 4</h3>
                            <div class="status-dot" id="led-4"></div>
                        </div>
                        <div class="valve-card" id="valve-card-5">
                            <h3>Van 5</h3>
                            <div class="status-dot" id="led-5"></div>
                        </div>
                        <div class="valve-card" id="valve-card-6">
                            <h3>Van 6</h3>
                            <div class="status-dot" id="led-6"></div>
                        </div>
                        <div class="valve-card" id="valve-card-7">
                            <h3>Van 7</h3>
                            <div class="status-dot" id="led-7"></div>
                        </div>
                        <div class="valve-card" id="valve-card-8">
                            <h3>Van 8</h3>
                            <div class="status-dot" id="led-8"></div>
                        </div>
                    </div>
                </section>

                <section class="section-sensors">
                    <h2 class="section-title">Th√¥ng s·ªë c·∫£m bi·∫øn</h2>
                    <div class="sensors-grid">
                        <div class="sensor-card " id="LuuLuong">
                            <h3>L∆∞u l∆∞·ª£ng </h3>
                            <div class="sensor-value">
                                <p>L∆∞u l∆∞·ª£ng 1: <span id="LuuLuong1">--</span></p>
                                <p>L∆∞u l∆∞·ª£ng 2: <span id="LuuLuong2">--</span></p>
                                <p>L∆∞u l∆∞·ª£ng t·ªïng: <span id="LuuLuongTong">--</span></p>
                            </div>
                        </div>
                        <div class="sensor-card">
                            <h3>√Åp su·∫•t</h3>
                            <div class="sensor-value">
                                <p>√Åp su·∫•t: <span id="ApXuat">--</span></p>
                            </div>
                        </div>
                        <div class="sensor-card">
                            <h3>ƒê·ªô d·∫´n ƒëi·ªán (EC)</h3>
                            <div class="sensor-value">
                                <p>N·ªìng ƒë·ªô: <span id="EC">--</span></p>
                            </div>
                        </div>
                        <div class="sensor-card">
                            <h3>ƒê·ªô pH</h3>
                            <div class="sensor-value">
                                <p>N·ªìng ƒë·ªô: <span id="PH">--</span></p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Valve Settings Modal -->
    <div id="valve-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">C√†i ƒë·∫∑t Van</h2>
                <button class="close-btn">&times;</button>
            </div>
            <form id="valve-form">
                <div class="form-group">
                    <label for="valve-mode">Ch·∫ø ƒë·ªô v·∫≠n h√†nh</label>
                    <div style="position: relative">
                        <span
                            style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); z-index: 1;">‚öôÔ∏è</span>
                        <select id="valve-mode" class="form-control" style="padding-left: 3rem; appearance: none">
                            <option value="auto">T·ª± ƒë·ªông (Auto)</option>
                            <option value="manual">Th·ªß c√¥ng (Manual)</option>
                        </select>
                    </div>
                </div>

                <input type="hidden" id="relay-id" value="">

                <div class="form-group" id="manual-controls" style="display: none;">
                    <label>ƒêi·ªÅu khi·ªÉn tr·ª±c ti·∫øp</label>
                    <button type="button" id="toggle-valve-btn" class="btn-primary" style="width: 100%; 
                           transition: all 0.3s ease; 
                           font-weight: 600; 
                           text-transform: uppercase; 
                           margin-bottom: 1rem;
                           cursor: pointer;
                           border: none;">
                        ƒêang t·∫£i...
                    </button>
                    <p style="font-size: 0.75rem; color: var(--text-muted); text-align: center;">
                        * Tr·∫°ng th√°i s·∫Ω c·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c qua h·ªá th·ªëng.
                    </p>
                </div>

                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">L∆∞u ch·∫ø ƒë·ªô</button>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
        integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
        crossorigin="anonymous"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // DOM Elements
            const valveCards = document.querySelectorAll(".valve-card");
            const modal = document.getElementById("valve-modal");
            const closeBtn = document.querySelector(".close-btn");
            const modalTitle = document.getElementById("modal-title");
            const valveForm = document.getElementById("valve-form");
            const modeSelect = document.getElementById("valve-mode");
            const manualControls = document.getElementById("manual-controls");
            const toggleBtn = document.getElementById("toggle-valve-btn");
            const valveIdInput = document.getElementById("relay-id");

            // State Management
            let currentRelayStates = [];

            // --- 1. SOCKET.IO SETUP ---
            const socket = io("http://192.168.137.184:8000");

            socket.on('connect', function () {
                console.log('‚úÖ Socket connected');
            });

            // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi tr·∫°ng th√°i 1 Relay
            socket.on('relay_status', function (data) {
                console.log('‚ö° Update 1 Relay:', data);

                // Chuy·ªÉn ƒë·ªïi format d·ªØ li·ªáu n·∫øu server g·ª≠i key "relay" thay v√¨ "relay_id"
                const formattedData = {
                    relay_id: data.relay || data.relay_id, // Ch·∫•p nh·∫≠n c·∫£ 2 tr∆∞·ªùng h·ª£p
                    state: data.state
                };

                updateSingleValveUI(formattedData);
                updateLocalState(formattedData);
            });

            // L·∫Øng nghe s·ª± ki·ªán c·∫≠p nh·∫≠t t·∫•t c·∫£ Relay (th∆∞·ªùng g·ª≠i khi m·ªõi connect)
            socket.on('relay_status_all', function (dataArray) {
                console.log('‚ö° Update All Relays:', dataArray);
                if (Array.isArray(dataArray)) {
                    currentRelayStates = dataArray;
                    dataArray.forEach(relay => updateSingleValveUI(relay));
                }
            });

            // --- 2. H√ÄM C·∫¨P NH·∫¨T UI ---

            // H√†m c·∫≠p nh·∫≠t m√†u ƒë√®n LED cho 1 van c·ª• th·ªÉ
            function updateSingleValveUI(relay) {
                const led = document.getElementById(`led-${relay.relay_id}`);
                if (led) {
                    const state = (relay.state || "").toLowerCase();
                    if (state === "on") {
                        led.style.backgroundColor = "var(--secondary-color)"; // Xanh
                        led.style.boxShadow = "0 0 10px rgba(52, 211, 153, 0.5)";
                    } else {
                        led.style.backgroundColor = "var(--danger-color)"; // ƒê·ªè
                        led.style.boxShadow = "0 0 10px rgba(248, 113, 113, 0.5)";
                    }
                }

                // N·∫øu Modal ƒëang m·ªü ƒë√∫ng c√°i van n√†y, c·∫≠p nh·∫≠t lu√¥n n√∫t b·∫•m trong Modal
                if (!modal.classList.contains("hidden") && valveIdInput.value == relay.relay_id) {
                    updateModalButtonState(relay.state);
                }
            }

            // H√†m c·∫≠p nh·∫≠t bi·∫øn l∆∞u tr·ªØ local
            function updateLocalState(newData) {
                const index = currentRelayStates.findIndex(r => r.relay_id == newData.relay_id);
                if (index !== -1) {
                    currentRelayStates[index] = { ...currentRelayStates[index], ...newData };
                } else {
                    currentRelayStates.push(newData);
                }
            }
            // H√†m c·∫≠p nh·∫≠t giao di·ªán n√∫t b·∫•m trong Modal
            function updateModalButtonState(state) {
                const stateLower = (state || "").toLowerCase();

                // Ki·ªÉm tra tr·∫°ng th√°i ƒë·ªÉ quy·∫øt ƒë·ªãnh m√†u s·∫Øc
                if (stateLower === "on") {
                    // Tr·∫°ng th√°i ƒêang B·∫≠t -> N√∫t hi·ªán ch·ªØ "T·∫Øt" v√† m√†u ƒê·ªè
                    toggleBtn.innerText = "T·∫Øt thi·∫øt b·ªã";
                    toggleBtn.style.backgroundColor = "var(--danger-color)";
                    toggleBtn.style.color = "white";
                    toggleBtn.style.border = "none";
                } else {
                    // Tr·∫°ng th√°i ƒêang T·∫Øt -> N√∫t hi·ªán ch·ªØ "B·∫≠t" v√† m√†u Xanh l√°
                    toggleBtn.innerText = "B·∫≠t thi·∫øt b·ªã";
                    toggleBtn.style.backgroundColor = "var(--secondary-color)";
                    toggleBtn.style.color = "white";
                    toggleBtn.style.border = "none";
                }

                // Th√™m hi·ªáu ·ª©ng chuy·ªÉn m√†u m∆∞·ª£t m√†
                toggleBtn.style.transition = "background-color 0.3s ease";
            }
            // --- 3. MODAL LOGIC ---

            // M·ªü Modal khi click v√†o Card
            valveCards.forEach((card) => {
                card.addEventListener("click", function () {
                    const valveId = this.id.split("-").pop(); // L·∫•y ID t·ª´ id="valve-card-1"
                    const valveName = this.querySelector("h3").innerText;

                    valveIdInput.value = valveId;
                    modalTitle.innerText = `C√†i ƒë·∫∑t ${valveName}`;

                    const relay = currentRelayStates.find((r) => r.relay_id == valveId);

                    if (relay) {
                        // Set Ch·∫ø ƒë·ªô (Auto/Manual)
                        const modeLower = (relay.mode || "").toLowerCase();
                        if (modeLower.includes("t·ª± ƒë·ªông") || modeLower === "auto") {
                            modeSelect.value = "auto";
                            manualControls.style.display = "none";
                        } else {
                            modeSelect.value = "manual";
                            manualControls.style.display = "block";
                            // C·∫≠p nh·∫≠t n√∫t B·∫≠t/T·∫Øt theo tr·∫°ng th√°i hi·ªán t·∫°i
                            updateModalButtonState(relay.state);
                        }
                    }
                    modal.classList.remove("hidden");
                });
            });

            // X·ª≠ l√Ω thay ƒë·ªïi Dropdown ch·∫ø ƒë·ªô
            if (modeSelect) {
                modeSelect.addEventListener("change", function () {
                    if (this.value === "manual") {
                        manualControls.style.display = "block";
                        // C·∫≠p nh·∫≠t l·∫°i tr·∫°ng th√°i n√∫t b·∫•m cho ƒë√∫ng v·ªõi th·ª±c t·∫ø khi v·ª´a chuy·ªÉn qua manual
                        const valveId = valveIdInput.value;
                        const relay = currentRelayStates.find((r) => r.relay_id == valveId);
                        if (relay) updateModalButtonState(relay.state);
                    } else {
                        manualControls.style.display = "none";
                    }
                });
            }

            if (toggleBtn) {
                toggleBtn.addEventListener("click", function () {
                    const valveId = valveIdInput.value;
                    if (!valveId) return;

                    const relay = currentRelayStates.find(
                        r => String(r.relay_id) === String(valveId)
                    );

                    const currentState = relay ? (relay.state || "").toLowerCase() : "off";
                    const newState = currentState === "on" ? "OFF" : "ON";

                    /* ===============================
                       1Ô∏è‚É£ UPDATE UI NGAY L·∫¨P T·ª®C
                    =============================== */
                    const optimisticData = {
                        relay_id: valveId,
                        state: newState
                    };

                    updateSingleValveUI(optimisticData);
                    updateLocalState(optimisticData);

                    /* ===============================
                       2Ô∏è‚É£ G·ª¨I SOCKET TOGGLE
                    =============================== */
                    if (socket && socket.connected) {
                        socket.emit("toggle_relay", {
                            relay_id: valveId,
                            state: newState
                        });
                        console.log(`üöÄ toggle_relay ‚Üí Van ${valveId}: ${newState}`);
                    } else {
                        alert("‚ùå M·∫•t k·∫øt n·ªëi Socket");
                    }

                    /* ===============================
                       3Ô∏è‚É£ ƒê√ìNG MODAL
                    =============================== */
                    modal.classList.add("hidden");
                });
            }
            // ƒê√≥ng Modal
            if (closeBtn) {
                closeBtn.addEventListener("click", () => modal.classList.add("hidden"));
            }
            window.addEventListener("click", (e) => {
                if (e.target === modal) modal.classList.add("hidden");
            });

            // L∆∞u ch·∫ø ƒë·ªô (Form Submit)
            if (valveForm) {
                valveForm.addEventListener("submit", function (e) {
                    e.preventDefault();
                    const mode = modeSelect.value;
                    const valveId = valveIdInput.value;
                    const dbMode = mode === "auto" ? "T·ª± ƒë·ªông" : "Th·ªß c√¥ng";

                    fetch("/api/update_relay_mode_db", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ relay_id: valveId, mode: dbMode }),
                    })
                        .then((res) => res.json())
                        .then((data) => {
                            console.log(`Saved mode for Valve ${valveId}: ${dbMode}`);
                            // Sau khi l∆∞u, c·∫≠p nh·∫≠t l·∫°i d·ªØ li·ªáu m·ªõi nh·∫•t
                            fetchValveStates();
                            modal.classList.add("hidden");
                        })
                        .catch((error) => console.error("Error saving mode:", error));
                });
            }

            // --- 4. API FETCHING (POLLING CHO C·∫¢M BI·∫æN & FALLBACK CHO RELAY) ---

            function updateSensorData() {
                // Fetch L∆∞u l∆∞·ª£ng
                fetch("/api/latest_luuluong_1_2_and_total")
                    .then(r => r.json())
                    .then(data => {
                        if (document.getElementById("LuuLuong1") && data.luu_luong_1)
                            document.getElementById("LuuLuong1").innerText = (data.luu_luong_1.TongLuuLuong || "--") + " L/P";
                        if (document.getElementById("LuuLuong2") && data.luu_luong_2)
                            document.getElementById("LuuLuong2").innerText = (data.luu_luong_2.TongLuuLuong || "--") + " L/P";
                        if (document.getElementById("LuuLuongTong"))
                            document.getElementById("LuuLuongTong").innerText = (data.tong_luu_luong || "--") + " L/P";
                    }).catch(e => console.error(e));

                // Fetch √Åp su·∫•t
                fetch("/api/latest_apxuat")
                    .then(r => r.json())
                    .then(data => {
                        const el = document.getElementById("ApXuat");
                        if (el) el.innerText = (data !== null ? data : "--") + " bar";
                    }).catch(e => console.error(e));

                // Fetch EC
                fetch("/api/latest_ec")
                    .then(r => r.json())
                    .then(data => {
                        const el = document.getElementById("EC");
                        if (el) el.innerText = (data !== null ? data : "--") + " mS/cm";
                    }).catch(e => console.error(e));

                // Fetch pH
                fetch("/api/latest_ph")
                    .then(r => r.json())
                    .then(data => {
                        const el = document.getElementById("PH");
                        if (el) el.innerText = (data !== null ? parseFloat(data).toFixed(2) : "--") + " pH";
                    }).catch(e => console.error(e));
            }

            // Fetch Valve States (Fallback n·∫øu Socket l·ª° b·ªã miss ho·∫∑c d√πng ƒë·ªÉ init ban ƒë·∫ßu)
            function fetchValveStates() {
                fetch("/api/relay_state")
                    .then(r => r.json())
                    .then(data => {
                        currentRelayStates = data;
                        data.forEach(relay => updateSingleValveUI(relay));
                    })
                    .catch(e => console.error("Error fetching valve states:", e));
            }

            // --- INIT ---
            updateSensorData();
            fetchValveStates(); // L·∫•y tr·∫°ng th√°i ban ƒë·∫ßu qua API

            // Polling: C·∫£m bi·∫øn (3s/l·∫ßn)
            setInterval(updateSensorData, 3000);

            // Polling: Van (C√≥ th·ªÉ gi·∫£m t·∫ßn su·∫•t xu·ªëng 10s/l·∫ßn ho·∫∑c b·ªè h·∫≥n n·∫øu tin t∆∞·ªüng Socket)
            // Gi·ªØ l·∫°i ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªìng b·ªô n·∫øu m·∫•t k·∫øt n·ªëi socket
            setInterval(fetchValveStates, 10000);
        });
    </script>
</body>

</html>